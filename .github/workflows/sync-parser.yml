name: Sync Parser from Release

# è§¦å‘æœºåˆ¶ï¼š
# 1. å½“å‘å¸ƒæ–° Release (Published) æ—¶è‡ªåŠ¨è§¦å‘
# 2. å…è®¸åœ¨ Actions é¡µé¢æ‰‹åŠ¨æŒ‰æŒ‰é’®è§¦å‘
on:
  release:
    types: [published]
  workflow_dispatch:

# æƒé™è®¾ç½®ï¼šå¿…é¡»ç»™äºˆå†™æƒé™ï¼Œå¦åˆ™æ— æ³•æ¨é€åˆ°ä»“åº“
permissions:
  contents: write

jobs:
  sync-file:
    name: Sync Release File to Repo
    runs-on: ubuntu-latest
    steps:
      # 1. æ™ºèƒ½è¯†åˆ«ç›®æ ‡åˆ†æ”¯
      # å¦‚æœæ˜¯å‘ç‰ˆï¼Œåˆ™é”å®šå‘ç‰ˆçš„ç›®æ ‡åˆ†æ”¯ï¼›å¦‚æœæ˜¯æ‰‹åŠ¨ï¼Œåˆ™é”å®šå½“å‰åˆ†æ”¯ã€‚
      - name: ğŸ” Determine Target Branch
        id: branch
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            TARGET="${{ github.event.release.target_commitish }}"
            echo "Trigger: Release Event"
          else
            TARGET="${{ github.ref_name }}"
            echo "Trigger: Manual Dispatch"
          fi
          echo "TARGET=$TARGET" >> $GITHUB_OUTPUT
          echo "âœ… Target Branch: $TARGET"

      # 2. æ£€å‡ºä»£ç 
      # fetch-depth: 0 ä¿è¯è·å–å®Œæ•´å†å²ï¼Œè¿™å¯¹åç»­åˆ‡æ¢åˆ†æ”¯è‡³å…³é‡è¦
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 3. ã€æ ¸å¿ƒä¿®æ­£ã€‘å¼ºåˆ¶åˆ‡æ¢åˆ†æ”¯
      # è¿™ä¸€æ­¥æ˜¯ä¸ºäº†è§£å†³ Release è§¦å‘æ—¶çš„ "Detached HEAD" æŠ¥é”™é—®é¢˜
      # å®ƒå¼ºåˆ¶å°† Git ç¯å¢ƒé‡ç½®åˆ°å…·ä½“çš„åˆ†æ”¯ä¸Šï¼Œè€Œä¸æ˜¯æ¸¸ç¦»åœ¨ Tag ä¸Š
      - name: ğŸ”§ Fix Git State (Switch to Branch)
        run: |
          TARGET="${{ steps.branch.outputs.TARGET }}"
          echo "Force switching git context to branch: $TARGET"
          git checkout -B $TARGET origin/$TARGET
          echo "Current branch status: $(git branch --show-current)"

      # 4. æš´åŠ›æ›¿æ¢é€»è¾‘
      # ä¸ç®¡æ—§æ–‡ä»¶æ˜¯ä»€ä¹ˆï¼Œå…ˆåˆ å…‰ï¼›ç„¶åä» Release ä¸‹è½½æœ€æ–°çš„ã€‚
      - name: ğŸ”„ Replace Parser File
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "--- Step 1: Delete old files ---"
          # åˆ é™¤å½“å‰ç›®å½•ä¸‹æ‰€æœ‰ä»¥ clash-parsers- å¼€å¤´çš„ yaml æ–‡ä»¶
          find . -maxdepth 1 -type f -name "clash-parsers-*.yaml" -print -delete
          
          echo "--- Step 2: Download new file ---"
          PATTERN="clash-parsers-*.yaml"
          
          if [ "${{ github.event_name }}" == "release" ]; then
            # Release è§¦å‘ï¼šä¸‹è½½ã€æœ¬æ¬¡ã€‘å‘å¸ƒçš„é‚£ä¸ªç‰ˆæœ¬
            TAG="${{ github.event.release.tag_name }}"
            echo "Downloading asset from Tag: $TAG"
            gh release download "$TAG" --pattern "$PATTERN" --clobber
          else
            # æ‰‹åŠ¨è§¦å‘ï¼šä¸‹è½½æ‰€æœ‰ Release ä¸­ã€æœ€æ–°ã€‘çš„é‚£ä¸ª
            echo "Downloading asset from Latest Release"
            gh release download --pattern "$PATTERN" --clobber
          fi
          
          echo "--- Result ---"
          ls -lh clash-parsers-*.yaml

      # 5. æäº¤å¹¶æ¨é€
      # åªè¦æ–‡ä»¶åå˜äº†ï¼Œæˆ–è€…å†…å®¹å˜äº†ï¼ŒGit éƒ½ä¼šæäº¤ã€‚åªæœ‰å®Œå…¨ä¸€æ¨¡ä¸€æ ·æ‰ä¼šè·³è¿‡ã€‚
      - name: ğŸš€ Commit and Push
        run: |
          # é…ç½® Git æœºå™¨äººèº«ä»½
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŠ¨
          if git diff --staged --quiet; then
            echo "âœ… No changes detected (File name and content are identical)."
          else
            echo "ğŸ”¥ Changes detected! Committing..."
            git commit -m "Auto-update: Sync parser file from release"
            
            # æ¨é€åˆ°æˆ‘ä»¬åœ¨ç¬¬3æ­¥é”å®šçš„ç›®æ ‡åˆ†æ”¯
            git push origin ${{ steps.branch.outputs.TARGET }}
            echo "ğŸ‰ Successfully pushed to $TARGET"
          fi
