name: Deploy New Parser (Clean)

on:
  # 1. å…è®¸å‘å¸ƒ Release æ—¶è‡ªåŠ¨è§¦å‘
  release:
    types: [published]
  # 2. å…è®¸ä½ æ‰‹åŠ¨æŒ‰æŒ‰é’®è§¦å‘ï¼ˆæœ€æ¨èå…ˆç”¨è¿™ä¸ªæµ‹ï¼‰
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy-job:
    runs-on: ubuntu-latest
    steps:
      # 1. æ‰“å°ä¸€ä¸‹å½“å‰è§¦å‘çš„åŸå› ï¼Œæ–¹ä¾¿ä½ çœ‹æ—¥å¿—
      - name: ğŸ” Debug Trigger Info
        run: |
          echo "Triggered by: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"

      # 2. è¯†åˆ«ç›®æ ‡åˆ†æ”¯
      - name: ğŸ¯ Determine Target Branch
        id: branch
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            # å¦‚æœæ˜¯ Releaseï¼Œç›®æ ‡å°±æ˜¯å‘ç‰ˆæ—¶é€‰çš„åˆ†æ”¯ (Target)
            TARGET="${{ github.event.release.target_commitish }}"
          else
            # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œç›®æ ‡å°±æ˜¯å½“å‰åˆ†æ”¯
            TARGET="${{ github.ref_name }}"
          fi
          echo "TARGET=$TARGET" >> $GITHUB_OUTPUT
          echo "Target Branch: $TARGET"

      # 3. æ‹‰å–ä»£ç  (å®Œæ•´å†å²)
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 4. ã€æ ¸å¿ƒã€‘å¼ºåˆ¶åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯ (å½»åº•è§£å†³ detached HEAD æŠ¥é”™)
      - name: ğŸ”§ Force Switch to Branch
        run: |
          TARGET="${{ steps.branch.outputs.TARGET }}"
          echo "Force switching git to branch: $TARGET"
          # å¼ºåˆ¶æŠŠå½“å‰ç¯å¢ƒé‡ç½®ä¸ºè¿œç¨‹åˆ†æ”¯çš„çŠ¶æ€
          git checkout -B $TARGET origin/$TARGET
          echo "Now on branch: $(git branch --show-current)"

      # 5. ã€åŠ¨ä½œã€‘åˆ æ‰æ—§çš„ï¼Œä¸‹è½½æ–°çš„
      - name: ğŸ”„ Replace Files
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "--- Deleting old yaml files ---"
          # åªè¦æ˜¯è¿™ä¸ªåå­—å¼€å¤´çš„ yamlï¼Œå…¨éƒ¨åˆ æ‰
          find . -maxdepth 1 -type f -name "clash-parsers-*.yaml" -delete
          
          echo "--- Downloading new asset ---"
          PATTERN="clash-parsers-*.yaml"
          
          if [ "${{ github.event_name }}" == "release" ]; then
            # Release è§¦å‘ï¼šä¸‹è½½æœ¬æ¬¡å‘å¸ƒçš„é‚£ä¸ªæ–‡ä»¶
            TAG="${{ github.event.release.tag_name }}"
            gh release download "$TAG" --pattern "$PATTERN" --clobber
          else
            # æ‰‹åŠ¨è§¦å‘ï¼šä¸‹è½½æœ€æ–°çš„ Release æ–‡ä»¶
            gh release download --pattern "$PATTERN" --clobber
          fi
          
          # æ‰“å°å‡ºæ¥çœ‹çœ‹ç°åœ¨å‰©ä¸‹å•¥
          ls -lh clash-parsers-*.yaml

      # 6. æäº¤å¹¶æ¨é€
      - name: ğŸš€ Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .
          
          # å¼ºåˆ¶æäº¤é€»è¾‘ï¼šåªè¦ git è®¤ä¸ºæœ‰å·®å¼‚ï¼ˆæ”¹åäº†ã€æ”¹å†…å®¹äº†ï¼‰ï¼Œå°±æäº¤
          if git diff --staged --quiet; then
            echo "âœ… æ–‡ä»¶åå’Œå†…å®¹å®Œå…¨ä¸€è‡´ï¼Œæ— éœ€æ›´æ–°ã€‚"
          else
            echo "ğŸ”¥ æ£€æµ‹åˆ°å˜åŒ–ï¼Œæ­£åœ¨æ›´æ–°..."
            git commit -m "Auto-update: Replace parser file via Action"
            
            # ç›´æ¥ pushï¼Œå› ä¸ºç¬¬4æ­¥å·²ç»åˆ‡å›äº†åˆ†æ”¯ï¼Œæ‰€ä»¥è¿™é‡Œä¸ä¼šæŠ¥é”™
            git push origin ${{ steps.branch.outputs.TARGET }}
            echo "ğŸ‰ æ¨é€æˆåŠŸï¼"
          fi
