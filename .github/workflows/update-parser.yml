name: Update Clash Parser from Release

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-parser:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest parser from Release
        id: get_parser
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // 获取最新 Release
            const release = await github.rest.repos.getLatestRelease({ owner, repo });

            // 找到 clash-parsers-*.yaml
            const asset = release.data.assets.find(a => /^clash-parsers-.*\.yaml$/i.test(a.name));

            if (!asset) {
              core.setFailed("❌ 没找到 clash-parsers-*.yaml 文件");
              return;
            }

            core.setOutput("asset_url", asset.browser_download_url);
            core.setOutput("asset_name", asset.name);

      - name: Delete old parser files
        run: |
          rm -f clash-parsers-*.yaml || true

      - name: Download latest parser file
        run: |
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -o "${{ steps.get_parser.outputs.asset_name }}" \
            "${{ steps.get_parser.outputs.asset_url }}"

      - name: Set git identity
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

      - name: Commit and push
        run: |
          git add clash-parsers-*.yaml
          git commit -m "Update parser to ${{ steps.get_parser.outputs.asset_name }}" || echo "Nothing to commit"
          git push origin HEAD:${{ github.ref_name }}
