name: Update Latest Parser File

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-file:
    runs-on: ubuntu-latest
    steps:
      - name: Determine Target Branch
        id: branch
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            # Release 触发时，获取目标分支（通常是 main）
            echo "TARGET_BRANCH=${{ github.event.release.target_commitish }}" >> $GITHUB_OUTPUT
            echo "Using release target branch: ${{ github.event.release.target_commitish }}"
          else
            # 手动触发时，获取当前分支
            echo "TARGET_BRANCH=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "Using current manual branch: ${{ github.ref_name }}"
          fi

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.branch.outputs.TARGET_BRANCH }}
          fetch-depth: 0

      - name: Delete Old Files
        run: |
          echo "Looking for old files to delete..."
          find . -maxdepth 1 -type f -name "clash-parsers-*.yaml" -print -delete
          echo "Old files deleted (if any)."

      - name: Download New File from Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Downloading latest asset..."
          PATTERN="clash-parsers-*.yaml"
          
          if [ "${{ github.event_name }}" == "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
            echo "Triggered by Release. Downloading assets from tag: $TAG"
            gh release download "$TAG" --pattern "$PATTERN" --clobber
          else
            echo "Triggered Manually. Downloading assets from the Latest Release"
            gh release download --pattern "$PATTERN" --clobber
          fi
          
          ls -lh clash-parsers-*.yaml

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Auto-update: Replace parser file with latest release version"
            
            # 【关键修改在这里】
            # 使用 HEAD:分支名 的格式，强制把当前游离状态的提交推送到远程目标分支
            git push origin HEAD:${{ steps.branch.outputs.TARGET_BRANCH }}
            
            echo "Successfully updated the file in branch ${{ steps.branch.outputs.TARGET_BRANCH }}"
          fi
