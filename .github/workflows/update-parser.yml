name: Update Clash Parser from Release

on:
  release:
    types: [published]

jobs:
  update-parser:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show branch info
        run: |
          echo "Event ref: ${{ github.ref }}"
          echo "Branch name: ${{ github.ref_name }}"

      - name: Delete old parser files
        run: |
          rm -f clash-parsers-*.yaml || true

      - name: Download latest release parser file
        run: |
          ASSETS_JSON='${{ toJson(github.event.release.assets) }}'
          echo "$ASSETS_JSON" | jq .

          DOWNLOAD_URL=$(echo "$ASSETS_JSON" | jq -r '.[] | select(.name | test("^clash-parsers-.*\\.yaml$")) | .browser_download_url')

          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" == "null" ]; then
            echo "❌ 没有找到 clash-parsers-*.yaml 资源"
            exit 1
          fi

          echo "Found asset url: $DOWNLOAD_URL"

          curl -L \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -o clash-parser.yaml \
            "$DOWNLOAD_URL"

      - name: Rename downloaded file to keep original name
        run: |
          REAL_NAME=$(echo '${{ toJson(github.event.release.assets) }}' | jq -r '.[] | select(.name | test("^clash-parsers-.*\\.yaml$")) | .name')
          mv clash-parser.yaml "$REAL_NAME"
          echo "Saved as: $REAL_NAME"

      - name: Set git identity
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

      - name: Commit and Push
        run: |
          git add clash-parsers-*.yaml
          git commit -m "Update parser from latest release" || echo "Nothing to commit"
          git push origin HEAD:${{ github.ref_name }}
