name: Update Parser (Force Replace)

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  force-update:
    runs-on: ubuntu-latest
    steps:
      # 1. ç¡®å®šç›®æ ‡åˆ†æ”¯
      - name: ğŸ” Determine Target Branch
        id: branch
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "TARGET=${{ github.event.release.target_commitish }}" >> $GITHUB_OUTPUT
          else
            echo "TARGET=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      # 2. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 3. ã€å…³é”®ä¿®å¤ã€‘å¼ºåˆ¶åˆ‡æ¢åˆ°åˆ†æ”¯ï¼Œå½»åº•è§£å†³ Error 128
      - name: ğŸ”§ Fix Detached HEAD
        run: |
          TARGET="${{ steps.branch.outputs.TARGET }}"
          echo "Force switching to branch: $TARGET"
          git checkout -B $TARGET origin/$TARGET

      # 4. æš´åŠ›æ›¿æ¢ï¼šåˆ æ‰æ—§çš„ï¼Œä¸‹è½½æ–°çš„
      - name: ğŸ”„ Replace File
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Step 1: Deleting ALL old parser files..."
          # åªè¦æ˜¯è¿™ä¸ªåå­—å¼€å¤´çš„ï¼Œç»Ÿç»Ÿåˆ æ‰ (è¿™å°±è§£å†³äº†æ”¹åé—®é¢˜)
          find . -maxdepth 1 -type f -name "clash-parsers-*.yaml" -delete
          
          echo "Step 2: Downloading the new file..."
          PATTERN="clash-parsers-*.yaml"
          
          if [ "${{ github.event_name }}" == "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
            gh release download "$TAG" --pattern "$PATTERN" --clobber
          else
            gh release download --pattern "$PATTERN" --clobber
          fi
          
          ls -lh clash-parsers-*.yaml

      # 5. æäº¤å¹¶æ¨é€
      - name: ğŸš€ Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .
          
          if git diff --staged --quiet; then
            echo "âœ… æ–‡ä»¶åå’Œå†…å®¹éƒ½å®Œå…¨ä¸€è‡´ï¼Œæ— éœ€æ›´æ–°ã€‚"
          else
            echo "ğŸ”¥ æ£€æµ‹åˆ°å˜åŠ¨ï¼ˆæ–‡ä»¶åå˜äº† æˆ– å†…å®¹å˜äº†ï¼‰ï¼Œæ­£åœ¨æ›´æ–°..."
            git commit -m "Auto-update: Force replace parser file"
            # å› ä¸ºç¬¬3æ­¥å·²ç»åˆ‡å›äº†åˆ†æ”¯ï¼Œè¿™é‡Œç›´æ¥ push å³å¯
            git push origin ${{ steps.branch.outputs.TARGET }}
          fi
