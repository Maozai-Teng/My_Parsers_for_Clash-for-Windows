name: Update Clash Parser From Latest Release

on:
  release:
    types: [published]     # 只在发布新 Release 时执行
  workflow_dispatch:        # 可手动触发

permissions:
  contents: write

jobs:
  update-parser:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Get Latest Release Asset
        id: get_asset
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const latest = await github.rest.repos.getLatestRelease({ owner, repo });

            const asset = latest.data.assets.find(a =>
              a.name.startsWith("clash-parsers") && a.name.endsWith(".yaml")
            );

            if (!asset) {
              core.setFailed("❌ 没找到 clash-parsers-*.yaml 文件");
              return;
            }

            core.setOutput("asset_url", asset.browser_download_url);
            core.setOutput("asset_name", asset.name);
          result-encoding: string

      - name: Download Latest Parser File
        run: |
          echo "下载: ${{ steps.get_asset.outputs.asset_name }}"
          curl -L -o "${{ steps.get_asset.outputs.asset_name }}" "${{ steps.get_asset.outputs.asset_url }}"

      - name: Remove Old Parser Files
        run: |
          find . -maxdepth 1 -name "clash-parsers-*.yaml" ! -name "${{ steps.get_asset.outputs.asset_name }}" -delete

      - name: Commit & Push
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          git add clash-parsers-*.yaml
          git commit -m "Update parser to ${{ steps.get_asset.outputs.asset_name }}" || echo "Nothing to commit"
          git push
