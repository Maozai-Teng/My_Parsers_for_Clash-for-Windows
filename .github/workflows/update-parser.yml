name: Auto Update Parser (Universal)

on:
  # 1. å‘å¸ƒ Release æ—¶è§¦å‘
  release:
    types: [published]
  # 2. æ‰‹åŠ¨æŒ‰æŒ‰é’®æ—¶è§¦å‘
  workflow_dispatch:

# å¿…é¡»èµ‹äºˆå†™æƒé™ï¼Œå¦åˆ™æ— æ³•æ¨é€ä»£ç 
permissions:
  contents: write

jobs:
  universal-update:
    runs-on: ubuntu-latest
    steps:
      # ã€ç¬¬ä¸€æ­¥ï¼šæ™ºèƒ½è¯†åˆ«ç›®æ ‡åˆ†æ”¯ã€‘
      # æ— è®ºæ˜¯å‘å¸ƒ Release è¿˜æ˜¯æŒ‰æŒ‰é’®ï¼Œéƒ½ç®—å‡ºæˆ‘ä»¬åˆ°åº•è¯¥æ“ä½œå“ªä¸ªåˆ†æ”¯
      - name: ğŸ§  Determine Target Branch
        id: branch
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            # å¦‚æœæ˜¯å‘ç‰ˆï¼Œç›®æ ‡å°±æ˜¯ Release æŒ‡å®šçš„åˆ†æ”¯ï¼ˆTarget: main/beta...ï¼‰
            TARGET="${{ github.event.release.target_commitish }}"
            echo "Trigger: Release created."
          else
            # å¦‚æœæ˜¯æŒ‰æŒ‰é’®ï¼Œç›®æ ‡å°±æ˜¯å½“å‰ä½ é€‰ä¸­çš„åˆ†æ”¯
            TARGET="${{ github.ref_name }}"
            echo "Trigger: Manual button."
          fi
          
          echo "TARGET_BRANCH=$TARGET" >> $GITHUB_OUTPUT
          echo "âœ… Targeted Branch: $TARGET"

      # ã€ç¬¬äºŒæ­¥ï¼šç²¾å‡†æ£€å‡ºåˆ†æ”¯ã€‘
      # å…³é”®ç‚¹ï¼šä½¿ç”¨ ref å‚æ•°å¼ºåˆ¶æ£€å‡ºåˆ†æ”¯åï¼Œå½»åº•é¿å¼€ Detached HEAD é—®é¢˜
      - name: ğŸ“¥ Checkout Branch Code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.branch.outputs.TARGET_BRANCH }}
          fetch-depth: 0

      # ã€ç¬¬ä¸‰æ­¥ï¼šæ¸…ç†æ—§æ–‡ä»¶ã€‘
      - name: ğŸ—‘ï¸ Remove Old Parsers
        run: |
          echo "Cleaning up old files..."
          # åˆ æ‰æ‰€æœ‰ clash-parsers- å¼€å¤´çš„ yaml æ–‡ä»¶ï¼Œåªä¿ç•™ Action åˆšè¦ä¸‹è½½çš„é‚£ä¸ª
          find . -maxdepth 1 -type f -name "clash-parsers-*.yaml" -print -delete

      # ã€ç¬¬å››æ­¥ï¼šä¸‹è½½æœ€æ–°æ–‡ä»¶ã€‘
      - name: â¬‡ï¸ Download New Asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PATTERN="clash-parsers-*.yaml"
          
          if [ "${{ github.event_name }}" == "release" ]; then
            # æƒ…å†µ A: Release è§¦å‘ï¼Œä¸‹è½½ã€æœ¬æ¬¡ã€‘å‘å¸ƒçš„é‚£ä¸ªç‰ˆæœ¬
            TAG="${{ github.event.release.tag_name }}"
            echo "Downloading assets from Release Tag: $TAG"
            gh release download "$TAG" --pattern "$PATTERN" --clobber
          else
            # æƒ…å†µ B: æ‰‹åŠ¨è§¦å‘ï¼Œä¸‹è½½ã€æœ€æ–°ã€‘çš„ä¸€ä¸ª Release
            echo "Downloading assets from Latest Release"
            gh release download --pattern "$PATTERN" --clobber
          fi
          
          ls -lh clash-parsers-*.yaml

      # ã€ç¬¬äº”æ­¥ï¼šæäº¤å¹¶æ¨é€ã€‘
      # å› ä¸ºç¬¬äºŒæ­¥å·²ç»åˆ‡åˆ°äº†åˆ†æ”¯ï¼Œè¿™é‡Œç›´æ¥ push å³å¯ï¼Œé€‚é…æ‰€æœ‰åˆ†æ”¯
      - name: ğŸš€ Commit and Push
        run: |
          # é…ç½® Git èº«ä»½
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŠ¨
          if git diff --staged --quiet; then
            echo "âš ï¸ No changes detected. Warehouse is already up to date."
          else
            git commit -m "Auto-update: Sync parser file with release"
            
            # ç›´æ¥ pushï¼ŒGit ä¼šè‡ªåŠ¨æ¨é€åˆ°æˆ‘ä»¬åœ¨ç¬¬äºŒæ­¥ checkout çš„é‚£ä¸ªåˆ†æ”¯
            git push
            echo "ğŸ‰ Successfully pushed to ${{ steps.branch.outputs.TARGET_BRANCH }}"
          fi
