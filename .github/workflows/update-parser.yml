name: Update Parser (Force Replace)

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  force-update:
    runs-on: ubuntu-latest
    steps:
      # 1. ç®—å‡ºç›®æ ‡åˆ†æ”¯ (Target)
      - name: ğŸ” Determine Target Branch
        id: branch
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "TARGET=${{ github.event.release.target_commitish }}" >> $GITHUB_OUTPUT
          else
            echo "TARGET=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      # 2. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 3. ã€å…³é”®ã€‘å¼ºåˆ¶åˆ‡æ¢åˆ°æ­£ç¡®çš„åˆ†æ”¯ (è§£å†³æŠ¥é”™ 128)
      - name: ğŸ”§ Fix Detached HEAD
        run: |
          TARGET="${{ steps.branch.outputs.TARGET }}"
          # å¼ºåˆ¶æŠŠå½“å‰ç¯å¢ƒæŒ‰åœ¨åˆ†æ”¯ä¸Š
          git checkout -B $TARGET origin/$TARGET

      # 4. ã€åŠ¨ä½œã€‘åˆ æ—§ + ä¸‹æ–°
      - name: ğŸ”„ Replace File
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Step 1: Deleting ALL old parser files..."
          # åªè¦æ˜¯è¿™ä¸ªåå­—å¼€å¤´çš„ï¼Œç»Ÿç»Ÿåˆ æ‰
          find . -maxdepth 1 -type f -name "clash-parsers-*.yaml" -delete
          
          echo "Step 2: Downloading the new file..."
          PATTERN="clash-parsers-*.yaml"
          
          if [ "${{ github.event_name }}" == "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
            gh release download "$TAG" --pattern "$PATTERN" --clobber
          else
            # æ‰‹åŠ¨è§¦å‘ï¼šä¸‹è½½æœ€æ–°çš„é‚£ä¸ª release æ–‡ä»¶
            gh release download --pattern "$PATTERN" --clobber
          fi
          
          echo "New file downloaded:"
          ls -lh clash-parsers-*.yaml

      # 5. æäº¤ (æ–‡ä»¶åå˜äº†ï¼Ÿå†…å®¹å˜äº†ï¼Ÿéƒ½ä¼šæäº¤ï¼)
      - name: ğŸš€ Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # æŠŠåˆšæ‰çš„åˆ é™¤æ“ä½œå’Œä¸‹è½½æ“ä½œéƒ½åŠ å…¥æš‚å­˜åŒº
          git add .
          
          # åªæœ‰å½“ã€æ–‡ä»¶åã€‘å’Œã€å†…å®¹ã€‘å®Œå…¨ä¸€æ¨¡ä¸€æ ·æ—¶ï¼Œæ‰è·³è¿‡
          if git diff --staged --quiet; then
            echo "âœ… ä»“åº“é‡Œçš„æ–‡ä»¶å·²ç»æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼ˆåŒåä¸”åŒå†…å®¹ï¼‰ï¼Œæ— éœ€æ›´æ–°ã€‚"
          else
            echo "ğŸ”¥ æ£€æµ‹åˆ°å˜åŠ¨ï¼ˆæ–‡ä»¶åå˜äº† æˆ– å†…å®¹å˜äº†ï¼‰ï¼Œæ­£åœ¨æ›´æ–°..."
            git commit -m "Auto-update: Force replace parser file"
            git push origin ${{ steps.branch.outputs.TARGET }}
            echo "ğŸ‰ æ›´æ–°æˆåŠŸï¼"
          fi
