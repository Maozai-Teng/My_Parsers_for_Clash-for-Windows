name: Debug and Force Update

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  debug-fix-job:
    runs-on: ubuntu-latest
    steps:
      # ã€æ­¥éª¤ 1ã€‘è¯†åˆ«ç›®æ ‡åˆ†æ”¯ï¼Œå¹¶æ‰“å°è°ƒè¯•ä¿¡æ¯
      - name: ðŸ” 1. Identify Branch & Debug Info
        id: info
        run: |
          echo "========== [DEBUG START] =========="
          echo "Event Name: ${{ github.event_name }}"
          
          # åˆ¤æ–­ç›®æ ‡åˆ†æ”¯
          if [ "${{ github.event_name }}" == "release" ]; then
            TARGET="${{ github.event.release.target_commitish }}"
            echo "Trigger: Release"
            echo "Release Target (Commitish): $TARGET"
          else
            TARGET="${{ github.ref_name }}"
            echo "Trigger: Manual"
            echo "Current Ref: $TARGET"
          fi
          
          echo "TARGET_BRANCH=$TARGET" >> $GITHUB_OUTPUT
          echo "Desired Target Branch: $TARGET"
          echo "========== [DEBUG END] =========="

      # ã€æ­¥éª¤ 2ã€‘æ‹‰å–ä»£ç ï¼ˆfetch-depth: 0 ä¿è¯æ‹‰å–å®Œæ•´åŽ†å²ï¼Œå¦åˆ™æ— æ³•åˆ‡æ¢åˆ†æ”¯ï¼‰
      - name: ðŸ“¥ 2. Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ã€æ­¥éª¤ 3ã€‘ðŸš¨ æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶ Git åˆ‡æ¢åˆ°åˆ†æ”¯ ðŸš¨
      # ä¸ç®¡ checkout å¤„äºŽä»€ä¹ˆçŠ¶æ€ï¼Œè¿™é‡Œæ‰‹åŠ¨å¼ºåˆ¶é‡ç½®åˆ°ç›®æ ‡åˆ†æ”¯
      - name: ðŸ”§ 3. Force Switch to Branch
        run: |
          TARGET="${{ steps.info.outputs.TARGET_BRANCH }}"
          
          echo "--- Git Status Before Fix (Likely Detached) ---"
          git status
          
          echo ">>> FORCING GIT TO SWITCH TO BRANCH: $TARGET <<<"
          # å¼ºåˆ¶åˆ›å»º(å¦‚æžœä¸å­˜åœ¨)å¹¶é‡ç½®æœ¬åœ°åˆ†æ”¯åˆ°è¿œç¨‹åˆ†æ”¯çš„çŠ¶æ€
          # è¿™è¡Œå‘½ä»¤æ˜¯è§£å†³é—®é¢˜çš„å…³é”®ï¼Œå®ƒä¼šæŠŠ 'HEAD' å¼ºè¡Œç»‘å›žåˆ†æ”¯ä¸Š
          git checkout -B "$TARGET" "origin/$TARGET"
          
          echo "--- Git Status After Fix (Should be on branch) ---"
          git status
          
          # åŒé‡æ£€æŸ¥ï¼šå¦‚æžœè¿˜ä¸æ˜¯åˆ†æ”¯ï¼Œç›´æŽ¥æŠ¥é”™åœæ­¢ï¼Œæ–¹ä¾¿æŽ’æŸ¥
          if [ "$(git symbolic-ref -q HEAD)" != "refs/heads/$TARGET" ]; then
            echo "âŒ ERROR: Failed to switch to branch $TARGET. Still detached!"
            exit 1
          else
            echo "âœ… SUCCESS: Confirmed we are strictly on branch '$TARGET'"
          fi

      # ã€æ­¥éª¤ 4ã€‘æ–‡ä»¶å¤„ç†ï¼ˆåˆ æ—§ã€ä¸‹æ–°ï¼‰
      - name: ðŸ“‚ 4. Replace Files
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Deleting old parser files..."
          find . -maxdepth 1 -type f -name "clash-parsers-*.yaml" -print -delete
          
          PATTERN="clash-parsers-*.yaml"
          if [ "${{ github.event_name }}" == "release" ]; then
             TAG="${{ github.event.release.tag_name }}"
             echo "Downloading from Release Tag: $TAG"
             gh release download "$TAG" --pattern "$PATTERN" --clobber
          else
             echo "Downloading from Latest Release"
             gh release download --pattern "$PATTERN" --clobber
          fi
          
          ls -lh clash-parsers-*.yaml

      # ã€æ­¥éª¤ 5ã€‘æäº¤å¹¶æŽ¨é€
      - name: ðŸš€ 5. Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .
          
          if git diff --staged --quiet; then
            echo "âš ï¸ No changes detected. Skipping push."
          else
            echo "Committing changes..."
            git commit -m "Auto-update: Sync parser with release"
            
            # å› ä¸ºæ­¥éª¤ 3 å·²ç»ä¿è¯äº†æˆ‘ä»¬åœ¨åˆ†æ”¯ä¸Šï¼Œè¿™é‡Œç›´æŽ¥ push å³å¯
            echo "Pushing to remote..."
            git push origin ${{ steps.info.outputs.TARGET_BRANCH }}
            echo "ðŸŽ‰ Done! Successfully pushed."
          fi
